name: test-tmp-dir

on:
  # run on all pushes to any branch
  push:
  # run only on master pull requests
  pull_request:
    branches: [master]

jobs:
  test-tmp-dir:
    name: Test and check coverage of 🐍 code
    strategy:
      matrix:
        python-version: ["38", "39", "310"]
        platform: [ubuntu-latest]
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v2
      - uses: cachix/install-nix-action@v17
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Cache poetry cache-dir
        uses: actions/cache@v2
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-${{ hashFiles('poetry.lock') }}-${{ hashFiles('flake.lock') }}-${{ matrix.python-version }}
      - name: Test with doit -> nix
        run: nix develop -c doit -v 3 test_tmp_dir:python${{ matrix.python-version }}
